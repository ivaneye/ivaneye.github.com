---
layout: post
date: 2017-07-27
title: Redis实用手册
categories: manual
tags: [redis,manual]
avatarimg: "/img/head.jpg"
author: wangyifan
published: false
---



## 什么是Redis

支持多种数据类型、发布订阅功能、主从复制、持久化及脚本扩展的非关系型内存数据库

- 使用内存存储的非关系型数据库
- 支持多种数据存储类型：string,list,set,zset,hash
- 支持发布订阅，主从复制，持久化，脚本

## Redis的应用场景

**常用使用途径**：

- 缓存
  - Cookie缓存
  - 网页缓存
  - 数据缓存
- 分布式锁
- 发布订阅
- 计数器/全局ID

**不常用使用途径**：

- 记录日志
- 数据库
- 服务发现
- 自动补全
- 队列
- 搜索

## Redis与其它同类产品的区别



| Name       | Type                                  | Data storage options                     | Query types                              | Additional features                      |
| ---------- | ------------------------------------- | ---------------------------------------- | ---------------------------------------- | ---------------------------------------- |
| Redis      | In-memory non-relational database     | Strings, lists, sets,hashes, sorted sets | Commands for each data type for common access patterns, with bulk operations, and partial transaction support | Publish/Subscribe,master/slave replication,disk persistence,scripting (stored procedures) |
| memcached  | In-memory key-value cache             | Mapping of keys to values                | Commands for create,read, update, delete,and a few others | Multithreaded serverfor additional performance |
| MySQL      | Relational database                   | Databases of tables of rows, views over tables, spatial and third-party extensions | SELECT, INSERT, UPDATE, DELETE,functions, stored procedures | ACID compliant (with InnoDB), master/slave and master/master replication |
| PostgreSQL | Relational database                   | Databases of tables of rows, views over tables, spatial and third-party extensions, customizable types | SELECT, INSERT, UPDATE, DELETE, built-in functions, custom stored procedures | ACID compliant, master/slave replication, multi-master replication (third party) |
| MongoDB    | On-disk non-relational document store | Databases of tables of schema-less BSON documents | Commands for create,read, update, delete,conditional queries,and more | Supports map-reduce operations, master/slave replication, sharding,spatial indexes |



## Redis的安装

### Windows

从如下路径下载msi安装包安装或zip包解压即可

```
https://github.com/MicrosoftArchive/redis/releases
```

### Linux

通过下面的命令下载，并解压Redis:

```
$ wget http://download.redis.io/releases/redis-4.0.1.tar.gz
$ tar xzf redis-4.0.1.tar.gz
$ cd redis-4.0.1
$ make
```

可执行程序在src目录下，通过如下命令启动Redis:

```
$ src/redis-server
```

通过redis-cli命令启动客户端，进行交互式测试:

```
$ src/redis-cli
redis> set foo bar
OK
redis> get foo
"bar"
```

## Redis数据结构

| Structure type | What it contains                         | Structure read/write ability             |
| -------------- | ---------------------------------------- | ---------------------------------------- |
| String         | Strings, integers, or floating-point values | Operate on the whole string, parts, increment/decrement the integers and floats |
| List           | Linked list of strings                   | Push or pop items from both ends, trim based on offsets, read individual or multiple items, find or remove items by value |
| Set            | Unordered collection of unique strings   | Add, fetch, or remove individual items, check membership, intersect, union, difference, fetch random items |
| ZSet           | Ordered mapping of string members to floating-point scores, ordered by score | Add, fetch, or remove individual values, fetch items based on score ranges or member value |
| Hash           | Unordered hash table of keys to values   | Add, fetch, or remove individual items, fetch the whole hash |



## 各数据结构的操作

#### String

| Command                                  | desc                                     | example                                  | result                  |
| ---------------------------------------- | ---------------------------------------- | ---------------------------------------- | ----------------------- |
| **SET** key value \[EX seconds\] \[PX milliseconds\] \[NX\|XX] | Set the string value of a key            | set num 10                               | OK                      |
| **SETEX** key seconds value              | Set the value and expiration of a key    | set a 10 1 (超时时间10s)                     | OK                      |
| **PSETEX** key milliseconds value        | Set the value and expiration in milliseconds of a key | set a 10000 1(超时10s)                     | OK                      |
| **SETNX** key value                      | Set the value of a key, only if the key does not exist | setnx b 2                                | 设置成功返回1，否则返回0           |
| **GET** key                              | Get the value of a key                   | get num                                  | 10                      |
| **INCR** key                             | Increment the integer value of a key by one | incr num                                 | 11                      |
| **INCRBY** key increment                 | Increment the integer value of a key by the given amount | incrby num 10                            | 21                      |
| **INCRBYFLOAT** key increment            | Increment the float value of a key by the given amount | incrbyfloat num 0.5                      | 22(执行两次)                |
| **DECR** key                             | Decrement the integer value of a key by one | decr num                                 | 21                      |
| **DECRBY** key decrement                 | Decrement the integer value of a key by the given number | decrby num 10                            | 11                      |
| **APPEND** key value                     | Append a value to a key                  | append num 1                             | "111"                   |
| **STRLEN** key                           | Get the length of the value stored in a key | strlen num                               | 3                       |
| **MSET** key value [key value ...]       | Set multiple keys to multiple values     | mset a 1 b 2                             | OK                      |
| **MGET** key [key ...]                   | Get the values of all the given keys     | mget a b                                 | 1 2                     |
| **SETBIT** key offset value              | Sets or clears the bit at offset in the string value stored at key | setbit s 2 1                             | 0                       |
| **GETBIT** key offset                    | Returns the bit value at offset in the string value stored at key | getbit s 2                               | 1                       |
| **MSETNX** key value [key value ...]     | Set multiple keys to multiple values, only if none of the keys exist | msetnx aa 1 bb 2                         | 设置成功返回1，否则返回0(有一个失败即失败) |
| **BITCOUNT** key [start end]             | Count set bits in a string(统计bit位上1的数量)  | bitcount s                               | 1(按byte偏移)              |
| **BITPOS** key bit \[start] \[end]       | Find first bit set or clear in a string  | bitpos s 1                               | 2                       |
| **BITOP** operation destkey key [key ...] | Perform bitwise operations between strings(AND,OR,XOR,NOT) | bitset ss 1 1;bitop OR t s ss;           | s与ss做位或运算，得到t           |
| **BITFIELD** key \[GET type offset] \[SET type offset value] \[INCRBY type offset increment] \[OVERFLOW WRAP \| SAT\| FAIL] | Perform arbitrary bitfield integer operations on strings(WRAP一个i8的整数，值为127，递增1会导致值变为-128;SAT一个i8的整数，值为120，递增10会导致值变为127;FAIL发生溢出时操作失败；) | BITFIELD bitkey SET i4 0 5(用bitkey的值，0-3位保存有符号整数值5。i4代表4位有符号整数，u4代表4位无符号整数。) | 0                       |
| **SETRANGE** key offset value            | Overwrite part of a string at key starting at the specified offset | setrange str 0 "s"                       | "s"                     |
| **GETRANGE** key start end               | Get a substring of the string stored at a key | getrange str 0 0                         | "s"                     |
| **GETSET** key value                     | Set the string value of a key and return its old value | getset num "hello"                       | "111"                   |



#### List

| Command                                | desc                                     | example              | result             |
| -------------------------------------- | ---------------------------------------- | -------------------- | ------------------ |
| LPUSH key value [value ...]            | Prepend one or multiple values to a list | lpush l 1 2 3        | 3[1 2 3]           |
| LPUSHX key value                       | Prepend a value to a list, only if the list exists | lpush l 1            | 4[1 1 2 3]         |
| RPUSH key value [value ...]            | Append one or multiple values to a list  | rpush l 1 2 3        | 7[1 1 2 3 1 2 3]   |
| RPUSHX key value                       | Append a value to a list, only if the list exists | rpushx l 1           | 8[1 1 2 3 1 2 3 1] |
| LPOP key                               | Remove and get the first element in a list | lpop l               | 1[1 2 3 1 2 3 1]   |
| RPOP key                               | Remove and get the last element in a list | rpop l               | 1[1 2 3 1 2 3]     |
| LSET key index value                   | Set the value of an element in a list by its index | lset l 0 3           | OK[3 2 3 1 2 3]    |
| RPOPLPUSH source destination           | Remove the last element in a list, prepend it to another list and return it | rpoplpush l a        | "3"[3 2 3 1 2]     |
| BLPOP key [key ...] timeout            | Remove and get the first element in a list, or block until one is available | blpop l 1            | 3[2 3 1 2]         |
| BRPOP key [key ...] timeout            | Remove and get the last element in a list, or block until one is available | brpop l 1            | 2[2 3 1]           |
| LREM key count value                   | Remove elements from a list.count > 0: Remove elements equal to value moving from head to tail.count < 0: Remove elements equal to value moving from tail to head.count = 0: Remove all elements equal to value. | lrem l 0 1           | 1[2 3]             |
| LINDEX key index                       | Get an element from a list by its index  | lindex l 2           | 0[2 3]             |
| LTRIM key start stop                   | Trim a list to the specified range       | ltrim l 0 0          | 1[2]               |
| LINSERT key BEFORE\| AFTER pivot value | Insert an element before or after another element in a list | linsert l before 2 1 | 2[1 2]             |
| LLEN key                               | Get the length of a list                 | llen l               | 2                  |
| LRANGE key start stop                  | Get a range of elements from a list      | lrange l 0  1        | 1 2                |
| BRPOPLPUSH source destination timeout  | Pop a value from a list, push it to another list and return it; or block until one is available | brpoplpush l a 1     | 2[1]               |

#### Set

| Command                                  | desc                                     | example                | result                             |
| ---------------------------------------- | ---------------------------------------- | ---------------------- | ---------------------------------- |
| SADD key member [member ...]             | Add one or more members to a set         | sadd s 1 2 3 4 5       | OK                                 |
| SCARD key                                | Get the number of members in a set       | scard s                | 5                                  |
| SMEMBERS key                             | Get all the members in a set             | smembers s             | "1" "2" "3" "4" "5"                |
| SISMEMBER key member                     | Determine if a given value is a member of a set | sismember s 2          | 1                                  |
| SRANDMEMBER key [count]                  | Get one or multiple random members from a set | srandmember s          | 4(随机)                              |
| SPOP key [count]                         | Remove and return one or multiple random members from a set | spop s                 | 1[2 3 4 5]                         |
| SREM key member [member ...]             | Remove one or more members from a set    | srem s 3               | 1[2 4 5]                           |
| SDIFF key [key ...]                      | Subtract multiple sets                   | sadd b 2 4 7;sdiff s b | 5                                  |
| SDIFFSTORE destination key [key ...]     | Subtract multiple sets and store the resulting set in a key | sdiffstore t s b       | 1(t=[5])                           |
| SINTER key [key ...]                     | Intersect multiple sets                  | sinter s b             | 2 4                                |
| SINTERSTORE destination key [key ...]    | Intersect multiple sets and store the resulting set in a key | sinter t s b           | 1(t=[2 4])                         |
| SMOVE source destination member          | Move a member from one set to another    | smove s b 5            | 1(s=[2 4],b=[2 4 5 7])             |
| SUNION key [key ...]                     | Add multiple sets                        | sunion s b             | 2 4 5 7                            |
| SUNIONSTORE destination key [key ...]    | Add multiple sets and store the resulting set in a key | sunionstore t s b      | 1(t=[2 4 5 7])                     |
| SSCAN key cursor \[MATCH pattern] \[COUNT count] | Incrementally iterate Set elements（当SCAN命令的游标参数被设置为 0 时， 服务器将开始一次新的迭代， 而当服务器向用户返回值为 0 的游标时， 表示迭代已结束。） | sscan s 0              | 迭代获取，每次10条，0为游标下标。用法类似mysql里的limit |

#### ZSet

| Command                                  | desc                                     | example                                  | result         |
| ---------------------------------------- | ---------------------------------------- | ---------------------------------------- | -------------- |
| ZADD key \[NX\|XX]\[CH] \[INCR] score member \[score member ...] | Add one or more members to a sorted set, or update its score if it already exists | zadd zs 1 1 2 2 3 3                      | 3              |
| ZCARD key                                | Get the number of members in a sorted set | zcard zs                                 | 3              |
| ZCOUNT key min max                       | Count the members in a sorted set with scores within the given values | zcount zs 1 2                            | 2              |
| ZINCRBY key increment member             | Increment the score of a member in a sorted set | zincrby zs 2 2                           | 4              |
| ZSCORE key member                        | Get the score associated with the given member in a sorted set | zscore zs 2                              | 4              |
| ZRANK key member                         | Determine the index of a member in a sorted set | zrank zs 2                               | 2              |
| ZREVRANK key member                      | Determine the index of a member in a sorted set, with scores ordered from high to low | zrevrank zs 2                            | 0              |
| ZREM key member [member ...]             | Remove one or more members from a sorted set | zrem zs 2                                | 1              |
| ZINTERSTORE destination numkeys key \[key ...] \[WEIGHTS weight \[weight ...]] [AGGREGATE SUM\|MIN\|MAX] | Intersect multiple sorted sets and store the resulting sorted set in a new key | zadd zb 2 3;zinterstore out 2 zs zb      | [3 5]          |
| ZLEXCOUNT key min max                    | Count the number of members in a sorted set between a given lexicographical range.成员名称前需要加 [ 符号作为开头, [ 符号与成员之间不能有空格 - 可以使用 - 和 + 表示得分最小值和最大值 | zlexcount zs [1 [3                       | 2              |
| ZRANGE key start stop [WITHSCORES]       | Return a range of members in a sorted set, by index | zrange zs 0 2                            | [1 3]          |
| ZREVRANGE key start stop [WITHSCORES]    | Return a range of members in a sorted set, by index, with scores ordered from high to low | zrevrange zs 0 1                         | [3 1]          |
| ZRANGEBYLEX key min max [LIMIT offset count] | Return a range of members in a sorted set, by lexicographical range | zrangebylex zs [1 [3                     | [1 3]          |
| ZREVRANGEBYLEX key max min [LIMIT offset count] | Return a range of members in a sorted set, by lexicographical range, ordered from higher to lower strings. | zrevrangebylex zs [3 [1                  | [3 1]          |
| ZRANGEBYSCORE key min max \[WITHSCORES] \[LIMIT offset count] | Return a range of members in a sorted set, by score | zrangebyscore zs 1 3                     | [1 3]          |
| ZREVRANGEBYSCORE key max min \[WITHSCORES] \[LIMIT offset count] | Return a range of members in a sorted set, by score, with scores ordered from high to low | zrevrangebyscore zs 1 3                  | [3 1]          |
| ZREMRANGEBYLEX key min max               | Remove all members in a sorted set between the given lexicographical range | zremrangebylex zs[1 [2                   | 1              |
| ZREMRANGEBYRANK key start stop           | Remove all members in a sorted set within the given indexes | zremrangebyrank zs 0 0                   | 1              |
| ZREMRANGEBYSCORE key min max             | Remove all members in a sorted set within the given scores | zremrangebyscore zs 0 0                  | 0              |
| ZUNIONSTORE destination numkeys key \[key ...] \[WEIGHTS weight \[weight ...]] [AGGREGATE SUM\|MIN\|MAX] | Add multiple sorted sets and store the resulting sorted set in a new key | zadd a 1 1 2 2;zadd b 2 2 3 3;zunionstore out 2 a b | [ 1 1 3 3 2 4] |
| ZSCAN key cursor \[MATCH pattern] \[COUNT count] | Incrementally iterate sorted sets elements and associated scores | zscan out 0                              | [1 1 3 3 2 4]  |

#### Hash

| Command                                  | desc                                     | example                 | result           |
| ---------------------------------------- | ---------------------------------------- | ----------------------- | ---------------- |
| HSET key field value                     | Set the string value of a hash field     | hset map k1 1           | 1                |
| HMSET key field value [field value ...]  | Set multiple hash fields to multiple values | hmset map k2 2 k3 3     | OK               |
| HSETNX key field value                   | Set the value of a hash field, only if the field does not exist | hsetnx map k3 3         | 0                |
| HGET key field                           | Get the value of a hash field            | hget map k1             | 1                |
| HMGET key field [field ...]              | Get the values of all the given hash fields | hmget map k1 k3         | [1 3]            |
| HGETALL key                              | Get all the fields and values in a hash  | hgetall map             | [k1 1 k2 2 k3 3] |
| HKEYS key                                | Get all the fields in a hash             | hkeys map               | [k1 k2 k3]       |
| HVALS key                                | Get all the values in a hash             | hvals map               | [1 2 3]          |
| HEXISTS key field                        | Determine if a hash field exists         | hexists map k2          | 1                |
| HLEN key                                 | Get the number of fields in a hash       | hlen map                | 3                |
| HSTRLEN key field                        | Get the length of the value of a hash field | hstrlen map k2          | 2                |
| HDEL key field [field ...]               | Delete one or more hash fields           | hdel map k2             | 1                |
| HINCRBY key field increment              | Increment the integer value of a hash field by the given number | hincrby map k3 1        | 4                |
| HINCRBYFLOAT key field increment         | Increment the float value of a hash field by the given amount | hincrbyfloat map k3 0.5 | 4.5              |
| HSCAN key cursor \[MATCH pattern] \[COUNT count] | Incrementally iterate hash fields and associated values | hscan map 0             | [k1 1 k3 4.5]    |

## Redis功能

### 发布订阅

| Command                                  | desc                                     | example                                  | result       |
| ---------------------------------------- | ---------------------------------------- | ---------------------------------------- | ------------ |
| SUBSCRIBE channel \[channel ...]         | Listen for messages published to the given channels | subscribe ch                             |              |
| PUBLISH channel message                  | Post a message to a channel              | publish ch 1                             |              |
| UNSUBSCRIBE \[channel \[channel ...]]    | Stop listening for messages posted to the given channels | unsubscribe ch                           |              |
| PSUBSCRIBE pattern \[pattern ...]        | Listen for messages published to channels matching the given patterns | psubscribe c?                            | 以c开头的channel |
| PUNSUBSCRIBE \[pattern \[pattern ...]]   | Stop listening for messages posted to channels matching the given patterns | punsubscribe c?                          |              |
| PUBSUB subcommand \[argument \[argument ...]] | Inspect the state of the Pub/Sub subsystem(查询发布订阅系统状态) | pubsub channels(列出当前活跃的channel)；pubsub numsub(返回订阅的客户端数量)；pubsub numpat(返回基于Pattern定于的客户端数量) |              |

### 持久化（快照，指令重演：优缺点对比）

- 快照
- 指令重演(append-only file)

### 数据安全-主备
### 分布式
### 事务

| Command             | desc                                     | example | result |
| ------------------- | ---------------------------------------- | ------- | ------ |
| MULTI               | Mark the start of a transaction block(类似sql里的setAutoCommit(false)) |         |        |
| EXEC                | Execute all commands issued after MULTI(类似sql里的commit) |         |        |
| DISCARD             | Discard all commands issued after MULTI  |         |        |
| WATCH key [key ...] | Watch the given keys to determine execution of the MULTI/EXEC block(提供CAS行为。被 WATCH 的键会被监视，并会发觉这些键是否被改动过了。 如果有至少一个被监视的键在 EXEC 执行之前被修改了， 那么整个事务都会被取消， EXEC 返回nil-reply来表示事务已经失败。) |         |        |
| UNWATCH             | Forget about all watched keys            |         |        |

Redis事务的目的是确保一系列的操作被一起执行。因为redis是单线程的！如果事务中的命令**入队失败**(不是执行失败！)，则放弃该事务！

Redis不支持事务回滚：

- Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由编程错误造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。
- 因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。

### 故障处理

### 性能