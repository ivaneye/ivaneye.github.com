<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Mybooklive修复 | 思考，执行，表达！</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Mybooklive修复</h1><a id="logo" href="/.">思考，执行，表达！</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/" class="current"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Mybooklive修复</h1><div class="post-meta">Nov 19, 2016<span> | </span><span class="category"><a href="/categories/other/">other</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/11/19/nas.html" href="/2016/11/19/nas.html#comments" class="ds-thread-count"></a><div class="post-content"><p>11年底告别租房，搬到了新家。当时智能电视还刚起步，买的55寸的三星电视，只支持简单的应用和DLNA。所以想法很简单，就是想在电脑上下载的视频可以直接在电视上播放。巧的是那时正好西数发布了Mybooklive这个网络NAS，特点是<strong>便宜</strong>，3T版才1千多点，也就是个硬盘的钱，当即购入，谁知果然便宜没好货！用了三年多，后来手贱，想在Mybooklive上搭个git服务器，然后Mybooklive就变砖了！我搜集了三年的1T多的数据，就这么没了！！！重装系统也无果，硬盘挂了，西数绿盘质量真不咋的～</p>
<p>本来想就算了，就安心把数据都放云盘吧！反正我用的50M的电信网络，下载速度还可以！谁知祸不单行，网盘又开始接二连三的关闭了！虽然我主力用的百度网盘，官方言论是不会关闭，但是谁能保证呢？毕竟官方打脸是分分钟的事！还是搞个私有云比较安心！</p>
<ul>
<li>NAS全称Network Attached Storage：网络附属存储</li>
<li>DLNA全称是DIGITAL LIVING NETWORK ALLIANCE：数字生活网络联盟。旨在解决个人PC，消费电器，移动设备在内的无线网络和有线网络的互联互通</li>
</ul>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>目前对私有云的需求不是很复杂。</p>
<ul>
<li>所有手机、电视、pad都能很容易的访问NAS上的资源</li>
<li>个人的一些资料能备份到NAS上</li>
<li>没有公网访问需求，公网访问需求通过百度网盘来分享</li>
</ul>
<a id="more"></a>
<p>这些需求原来的Mybooklive即可以满足需求。现在我个人不推荐买Mybooklive，因为目前的私有云解决方案很多(不过我没用过其它的，所以也不具体推荐！)，Mybooklive的体验并不好。不过我已经折腾了三年了，一是熟悉了，二是有“沉没成本”的投入，最重要的一点是<strong>木有钱</strong>！</p>
<p>所以在双11入手了一块东芝1T的盘！我大概估算了一下，我原来1T的数据，其实大部分都是我当初舍不得删或者懒得删的数据，真正的数据并没有那么多，1T应该差不多了！</p>
<ul>
<li><strong>沉没成本</strong>：已经付出且不可收回的成本。</li>
</ul>
<p>对于沉没成本最近接触比较多，有些感想，后面总结！</p>
<h1 id="重装系统"><a href="#重装系统" class="headerlink" title="重装系统"></a>重装系统</h1><p>Mybooklive其实就是一个简单的电脑，运行的是debian系统！支持ssh,ftp，可以安装一些应用，实现例如离线bt,git服务等功能！</p>
<p>具体流程参考<a href="https://my.oschina.net/u/248080/blog/207665" target="_blank" rel="external">这里</a></p>
<p>买的硬盘连接线，直接通过USB接口，把硬盘接到电脑上，我用的是Linux Mint系统，如果是windows系统，需要用虚拟机安装debian系的Linux!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt－get install fuseext2 parted</div><div class="line">sudo parted -l //找到磁盘标识，如/dev/sdb</div><div class="line">sudo fuseext2 -o allow_other -o ro -o sync_read /dev/sdb4 /mnt/    #这个命令我死活执行不成功，不过算了，不影响，因为我不需要备份</div></pre></td></tr></table></figure>
<ul>
<li>下载<a href="http://download.wdc.com/nas/apnc-023205-046-20120910.deb" target="_blank" rel="external">apnc-023205-046-20120910.deb</a>这个版本固件，我只有这个版本安装成功了！</li>
<li>从固件中提取rootfs.img</li>
<li>把下面的执行脚本拷贝下来，保存成debrick.sh</li>
<li>运行脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ./debrick.sh /dev/sdb rootfs.img destroy</div></pre></td></tr></table></figure>
<h1 id="升级系统"><a href="#升级系统" class="headerlink" title="升级系统"></a>升级系统</h1><p>目前最新的版本是apnc-024310-048-20150507.deb,直接从Mybooklive官网下载即可。</p>
<p>但是使用上面的方法重装系统后，无法使用管理界面里的离线升级！在线升级一直0%，没有进度，所以只能手动升级。</p>
<p>把下载的最新版固件上传到public目录下，执行如下命令！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./updateFirmwareFromFile.sh /shares/Public/文件名</div></pre></td></tr></table></figure>
<p>管理界面自动进入升级界面！</p>
<h1 id="升级DNLA服务"><a href="#升级DNLA服务" class="headerlink" title="升级DNLA服务"></a>升级DNLA服务</h1><p>默认Mybooklive的DNLA服务是twonkymedia，支持的视频格式很有限。后来Mybooklive提供了自己的DLNA服务，从<a href="http://support.wdc.com/knowledgebase/answer.aspx?ID=7839&amp;lang=cn" target="_blank" rel="external">Mybooklive固件帮助页面</a>下载后，和前面的升级系统一样进行操作即可！</p>
<h1 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">#</div><div class="line"># The purpose of the script is to reinstall the operating system (debrick) on</div><div class="line"># a harddrive that has been extracted from the housing of a WD MyBook Live.</div><div class="line">#</div><div class="line"></div><div class="line">#help screen</div><div class="line">if  [ $# = 1 -a &quot;$1&quot; = &quot;--help&quot; ]; then</div><div class="line">echo &quot;</div><div class="line">standard use of script is:</div><div class="line">    sudo ./debricker.sh     the script will find out what disk to use, it will not</div><div class="line">                            touch the partition tables and therefore perserves data.</div><div class="line">                            it will look what the newest version of the firmware is</div><div class="line">                            via internet and then search for it in current folder or</div><div class="line">                            subfolders. if none is found it will download one.</div><div class="line"></div><div class="line">possible options are:</div><div class="line">    /dev/sd?                path to the disk from mybook live. if not given, the script</div><div class="line">                            will figure it out on its own.</div><div class="line">    /*/*.img                path to the firmware that will be written to the disk. if</div><div class="line">                            not given, the script will search for and then download it.</div><div class="line">    destroy                 script will rewrite the partition table of disk,</div><div class="line">                            this will not perserve data, must match /dev/sd?.</div><div class="line"></div><div class="line">example</div><div class="line">    sudo ./debricker.sh /dev/sda /firmwares/mine.img destroy</div><div class="line">&quot;</div><div class="line">exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">echo</div><div class="line"></div><div class="line">#check that requirements are fullfilled</div><div class="line">if [ &quot;$(id -u)&quot; != &quot;0&quot; ]; then</div><div class="line">    echo -e &quot;this script must be run as root.\n&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line">if ! which mdadm &gt; /dev/null; then</div><div class="line">    echo -e &quot;this script requires the mdadm package.\n&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">#making sure the mountpoint is available</div><div class="line">rootfsMount=/mnt/md0</div><div class="line">if [ -e $&#123;rootfsMount&#125; ]; then</div><div class="line">    if mountpoint -q $&#123;rootfsMount&#125;; then</div><div class="line">        echo &quot;$&#123;rootfsMount&#125; needs to be unmounted.&quot;</div><div class="line">        exit 1;</div><div class="line">    fi</div><div class="line">fi</div><div class="line">test -d &quot;./mnt&quot; || mkdir -p &quot;/mnt&quot;</div><div class="line">test -d &quot;$rootfsMount&quot; || mkdir -p &quot;$rootfsMount&quot;</div><div class="line"></div><div class="line">#making sure that there is no raid unit running</div><div class="line">rootfsRaid=/dev/md0</div><div class="line">if [ -e $rootfsRaid ]; then</div><div class="line">    echo -e &quot;\n$rootfsRaid already exists! you need to stop and remove it.\n&quot;</div><div class="line">    exit 1;</div><div class="line">fi</div><div class="line"></div><div class="line">#standard choices</div><div class="line">disk=notset</div><div class="line">image_img=notset</div><div class="line">destroy=false</div><div class="line"></div><div class="line">#handles the arguments and sets options</div><div class="line">for (( arg=1; arg&lt;=$&#123;#&#125;; arg++ ))</div><div class="line">do</div><div class="line">    case $&#123;!arg&#125; in</div><div class="line">    /dev/sd?)    disk=$&#123;!arg&#125;;;</div><div class="line">    *.img)        image_img=$&#123;!arg&#125;;;</div><div class="line">    &quot;destroy&quot;)    destroy=true;;</div><div class="line">    *)             echo &quot;unknown argument: $&#123;!arg&#125;&quot;</div><div class="line">                exit 1</div><div class="line">    esac</div><div class="line">done</div><div class="line"></div><div class="line">echo &quot;********************** DISK           **********************&quot;</div><div class="line">echo</div><div class="line"></div><div class="line">#figure out what disk to use</div><div class="line">if [ $disk = &quot;notset&quot; ]; then</div><div class="line">    for x in &#123;a..z&#125;</div><div class="line">    do</div><div class="line">        #avoid a to literal matching in order to avoid incompability.</div><div class="line">        if [ -e /dev/sd$&#123;x&#125; ];                                then</div><div class="line">        diskTest=$(parted --script /dev/sd$&#123;x&#125; print)</div><div class="line">        if [ ! -e /dev/sd$&#123;x&#125;0 -a ! -e /dev/sd$&#123;x&#125;5 ];            then</div><div class="line">        if [[ $diskTest = *WD??EARS* ]];                        then</div><div class="line">        if [[ $diskTest = *??00GB* ]];                            then</div><div class="line">        if [[ $diskTest = *3*B*B*5??MB*primary* ]];                then</div><div class="line">        if [[ $diskTest = *1*B*B*2???MB*ext3*primary*raid* ]];    then</div><div class="line">        if [[ $diskTest = *2*B*B*2???MB*ext3*primary*raid* ]];    then</div><div class="line">        if [[ $diskTest = *4*B*B*GB*ext4*primary* ]];            then</div><div class="line">            if [ $disk != notset ];                                then</div><div class="line">                echo &quot;multiple disk founds, you must enter the path manually:&quot;</div><div class="line">                echo &quot;   sudo ./debricker.sh /dev/sd?&quot;</div><div class="line">                exit 1;</div><div class="line">            fi</div><div class="line">            disk=/dev/sd$&#123;x&#125;</div><div class="line">        fi; fi; fi;    fi;    fi;    fi; fi; fi</div><div class="line">    done</div><div class="line"></div><div class="line">    if [ $disk == notset ]; then</div><div class="line">        echo &quot;script could not find a matching sd unit connected to system.&quot;</div><div class="line">        exit 1</div><div class="line">    fi</div><div class="line">else</div><div class="line">    if [ ! -e $disk ]; then</div><div class="line">        echo &quot;$disk does not exist.&quot;</div><div class="line">        exit 1;</div><div class="line">    fi</div><div class="line">fi</div><div class="line"></div><div class="line">echo -e &quot;script will use the following disk: \n&quot;</div><div class="line">parted --script $disk print</div><div class="line">read -p &quot;is this REALLY the disk you want? [y] &quot; -n 1</div><div class="line">if ! [[ $REPLY =~ ^[Yy]$ ]]; then</div><div class="line">    echo -e &quot;\nuser did not confirm, nothing was done.\n&quot;</div><div class="line">    exit 1;</div><div class="line">fi</div><div class="line">echo</div><div class="line"></div><div class="line">diskRoot1=$&#123;disk&#125;1</div><div class="line">diskRoot2=$&#123;disk&#125;2</div><div class="line">diskSwap=$&#123;disk&#125;3</div><div class="line">diskData=$&#123;disk&#125;4</div><div class="line"></div><div class="line">echo</div><div class="line">echo &quot;********************** IMAGE          **********************&quot;</div><div class="line">echo</div><div class="line"></div><div class="line">#the image was not given as parameter</div><div class="line">if [ $image_img = notset ]; then</div><div class="line">    #find out what the latest version of firmware is</div><div class="line">    if ! which curl &gt; /dev/null; then</div><div class="line">        echo -e &quot;\nthis script requires the curl package, either install it or specify image file.\n&quot;</div><div class="line">        exit 1</div><div class="line">    fi</div><div class="line">    wdc_homepage=&quot;http://websupport.wdc.com/firmware/list.asp&quot;</div><div class="line">    wdc_latestfirmware=$(curl &quot;$&#123;wdc_homepage&#125;?type=AP1NC&amp;fw=01.03.03&quot; 2&gt; /dev/null | awk &apos; &#123;</div><div class="line">        if ( match($0, &quot;upgrade file&quot; ) != 0 ) &#123;</div><div class="line">            split($0, http, &quot;\&quot;&quot;);</div><div class="line">            print http[2];</div><div class="line">            exit 1;</div><div class="line">        &#125;</div><div class="line">    &#125;&apos;)</div><div class="line">    latestversion_simple=$(echo $wdc_latestfirmware | cut -d&apos;-&apos; -f 2)</div><div class="line">    latestversion_pattern=$(echo $latestversion_simple | sed &apos;s/../&amp;*/g;s/:$//&apos;)</div><div class="line">    if [ &quot;$latestversion_simple&quot; == &quot;&quot; -o &quot;$latestversion_pattern&quot; == &quot;&quot; ]; then</div><div class="line">        echo -e &quot;\ncould not fetch the latest version!\n&quot;</div><div class="line">        exit 1;</div><div class="line">    fi</div><div class="line">    echo &quot;checking:     $&#123;latestversion_simple&#125;&quot;</div><div class="line">    echo &quot;searching:    ./*/*$&#123;latestversion_pattern&#125;.img&quot;</div><div class="line">    image_img=$(find ./ -type f -name &quot;*$&#123;latestversion_pattern&#125;.img&quot; -print; 2&gt;/dev/null)</div><div class="line"></div><div class="line">    #get the latest firmware either from subdirs or internet</div><div class="line">    case `echo $image_img | wc -w` in</div><div class="line">    0)  echo &quot;searching:    ./*/*$&#123;latestversion_pattern&#125;.deb&quot;</div><div class="line">        test -d &quot;./firmware&quot; || mkdir -p &quot;./firmware&quot;</div><div class="line">        image_deb=$(find ./ -type f -name &quot;*$&#123;latestversion_pattern&#125;.deb&quot; -print; 2&gt;/dev/null)</div><div class="line">        image_img=&quot;./firmware/rootfs_$latestversion_simple.img&quot;</div><div class="line">        if ! [ `echo $image_deb | wc -w` == 1 ]; then</div><div class="line">            image_deb=&quot;./firmware/rootfs_$latestversion_simple.deb&quot;</div><div class="line">            echo</div><div class="line">            echo &quot;downloading:  $image_deb&quot;</div><div class="line">            read -p &quot;confirm [y]:  &quot; -n 1</div><div class="line">            if ! [[ $REPLY =~ ^[Yy]$ ]]; then</div><div class="line">                exit 1</div><div class="line">            fi</div><div class="line">            echo</div><div class="line">            curl $wdc_latestfirmware &gt; $image_deb</div><div class="line">            if [ $? != 0 ]; then</div><div class="line">                echo -e &quot;\ndownloading encountered problems.\n&quot;</div><div class="line">                exit 1;</div><div class="line">            fi</div><div class="line">        fi</div><div class="line">        echo</div><div class="line">        echo    &quot;will extract: $image_deb&quot;</div><div class="line">        read -p &quot;confirm [y]:  &quot; -n 1</div><div class="line">        echo</div><div class="line">        if ! [[ $REPLY =~ ^[Yy]$ ]]; then</div><div class="line">            exit 1</div><div class="line">        fi</div><div class="line">        echo &quot;extracting:   ./firmware/rootfs_$&#123;latestversion_simple&#125;.img&quot;</div><div class="line">        ar p $image_deb data.tar.lzma | unlzma | tar -x -C ./firmware</div><div class="line">        if [ $? != 0 ]; then</div><div class="line">            echo -e &quot;\nextraction encountered problems.\n&quot;</div><div class="line">            exit 1;</div><div class="line">        fi</div><div class="line">        mv ./firmware/CacheVolume/upgrade/rootfs.img ./firmware/rootfs_$&#123;latestversion_simple&#125;.img</div><div class="line">        rm -rf ./firmware/CacheVolume;;</div><div class="line">    1)  echo &quot;found:        $image_img&quot;;;</div><div class="line">    *)  echo -e &quot;\nmultiple image_img files was found.&quot;</div><div class="line">        exit 1</div><div class="line">    esac</div><div class="line">else</div><div class="line">    if [ ! -e $image_img ]; then</div><div class="line">        echo &quot;$image_img does not exist.&quot;</div><div class="line">        exit 1;</div><div class="line">    fi</div><div class="line">fi</div><div class="line"></div><div class="line">#construct the swap program</div><div class="line">echo &quot;\</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;sys/mount.h&gt;</div><div class="line"></div><div class="line">#define MD_RESERVED_BYTES      (64 * 1024)</div><div class="line">#define MD_RESERVED_SECTORS    (MD_RESERVED_BYTES / 512)</div><div class="line"></div><div class="line">#define MD_NEW_SIZE_SECTORS(x) ((x &amp; ~(MD_RESERVED_SECTORS - 1)) - MD_RESERVED_SECTORS)</div><div class="line"></div><div class="line">main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line">    int fd, i;</div><div class="line">    unsigned long size;</div><div class="line">    unsigned long long offset;</div><div class="line">    char super[4096];</div><div class="line">    if (argc != 2) &#123;</div><div class="line">        fprintf(stderr, \&quot;Usage: swap_super device\\n\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    fd = open(argv[1], O_RDWR);</div><div class="line">    if (fd&lt;0) &#123;</div><div class="line">        perror(argv[1]);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    if (ioctl(fd, BLKGETSIZE, &amp;size)) &#123;</div><div class="line">        perror(\&quot;BLKGETSIZE\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    offset = MD_NEW_SIZE_SECTORS(size) * 512LL;</div><div class="line">    if (lseek64(fd, offset, 0) &lt; 0LL) &#123;</div><div class="line">        perror(\&quot;lseek64\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    if (read(fd, super, 4096) != 4096) &#123;</div><div class="line">        perror(\&quot;read\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for (i=0; i &lt; 4096 ; i+=4) &#123;</div><div class="line">        char t = super[i];</div><div class="line">        super[i] = super[i+3];</div><div class="line">        super[i+3] = t;</div><div class="line">        t=super[i+1];</div><div class="line">        super[i+1]=super[i+2];</div><div class="line">        super[i+2]=t;</div><div class="line">    &#125;</div><div class="line">    /* swap the u64 events counters */</div><div class="line">    for (i=0; i&lt;4; i++) &#123;</div><div class="line">        /* events_hi and events_lo */</div><div class="line">        char t=super[32*4+7*4 +i];</div><div class="line">        super[32*4+7*4 +i] = super[32*4+8*4 +i];</div><div class="line">        super[32*4+8*4 +i] = t;</div><div class="line"></div><div class="line">        /* cp_events_hi and cp_events_lo */</div><div class="line">        t=super[32*4+9*4 +i];</div><div class="line">        super[32*4+9*4 +i] = super[32*4+10*4 +i];</div><div class="line">        super[32*4+10*4 +i] = t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (lseek64(fd, offset, 0) &lt; 0LL) &#123;</div><div class="line">        perror(\&quot;lseek64\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    if (write(fd, super, 4096) != 4096) &#123;</div><div class="line">        perror(\&quot;write\&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    exit(0);</div><div class="line"></div><div class="line">&#125;&quot; &gt;./swap.c</div><div class="line"></div><div class="line">gcc swap.c -o swap</div><div class="line">rm swap.c</div><div class="line"></div><div class="line">echo</div><div class="line">echo &quot;********************** IMPLEMENTATION **********************&quot;</div><div class="line"></div><div class="line">echo -e &quot;</div><div class="line">everything is now prepared!</div><div class="line">device:       $disk</div><div class="line">image_img:    $image_img</div><div class="line">destroy:      $destroy\n&quot;</div><div class="line"></div><div class="line">read -p &quot;this is the point of no return, continue? [y] &quot; -n 1</div><div class="line">echo</div><div class="line">if ! [[ $REPLY =~ ^[Yy]$ ]]; then</div><div class="line">    exit 1;</div><div class="line">fi</div><div class="line">echo</div><div class="line"></div><div class="line">#rewrite the partition table</div><div class="line">if [ $destroy = true ]; then</div><div class="line">    backgroundPattern=&quot;$&#123;backgroundPattern:-0&#125;&quot;</div><div class="line"></div><div class="line">    dd if=/dev/zero of=$diskRoot1 bs=1M count=32</div><div class="line">    dd if=/dev/zero of=$diskRoot2 bs=1M count=32</div><div class="line">    dd if=/dev/zero of=$diskSwap bs=1M count=32</div><div class="line">    dd if=/dev/zero of=$diskData bs=1M count=32</div><div class="line">    badblocks -swf -b 1048576 -t $&#123;backgroundPattern&#125; $&#123;disk&#125; 16 0</div><div class="line"></div><div class="line">    sync</div><div class="line">    sleep 2</div><div class="line"></div><div class="line">    parted $disk --align optimal &lt;&lt;EOP</div><div class="line">mklabel gpt</div><div class="line">mkpart primary 528M  2576M</div><div class="line">mkpart primary 2576M 4624M</div><div class="line">mkpart primary 16M 528M</div><div class="line">mkpart primary 4624M -1M</div><div class="line">set 1 raid on</div><div class="line">set 2 raid on</div><div class="line">quit</div><div class="line">EOP</div><div class="line"></div><div class="line">    sync</div><div class="line">    sleep 1</div><div class="line"></div><div class="line">    #blocksize 65536 is required by the hardware, you won&apos;t be able to mount if different.</div><div class="line">    mkfs.ext4 -b 65536 -m 0 $diskData</div><div class="line"></div><div class="line">    echo</div><div class="line">    read -p &quot;destroying was done, would you like to continue with installation? [y] &quot; -n 1</div><div class="line">    echo -e</div><div class="line">    if ! [[ $REPLY =~ ^[Yy]$ ]]; then</div><div class="line">        exit 1;</div><div class="line">    fi</div><div class="line">fi</div><div class="line"></div><div class="line">#write the image to the raid disk</div><div class="line">echo</div><div class="line">sync</div><div class="line">mdadm --create $rootfsRaid --verbose --metadata=0.9 --raid-devices=2 --level=raid1 --run $diskRoot1 missing</div><div class="line">mdadm --wait $rootfsRaid</div><div class="line">sync</div><div class="line">sleep 2</div><div class="line">mkfs.ext3 -c -b 4096 $rootfsRaid</div><div class="line">sync</div><div class="line">sleep 2</div><div class="line"></div><div class="line">mdadm $rootfsRaid --add --verbose $diskRoot2</div><div class="line">echo</div><div class="line">echo -n &quot;synchronize raid... &quot;</div><div class="line">sleep 2</div><div class="line">mdadm --wait $rootfsRaid</div><div class="line">sync</div><div class="line">echo -e &quot;done\n&quot;</div><div class="line">echo &quot;copying image to disk... &quot;</div><div class="line">dd if=$image_img of=$rootfsRaid</div><div class="line">mount $rootfsRaid $rootfsMount</div><div class="line">cp $rootfsMount/usr/local/share/bootmd0.scr $rootfsMount/boot/boot.scr</div><div class="line">echo &quot;enabled&quot; &gt; $rootfsMount/etc/nas/service_startup/ssh</div><div class="line">sync</div><div class="line">sync</div><div class="line">sync</div><div class="line">umount $rootfsMount</div><div class="line">rmdir $rootfsMount</div><div class="line">mdadm --stop $rootfsRaid</div><div class="line">./swap $diskRoot1</div><div class="line">./swap $diskRoot2</div><div class="line">rm ./swap</div><div class="line"></div><div class="line">echo</div><div class="line">echo &quot;all done! device should be debricked!&quot;</div><div class="line">echo</div></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://download.wdc.com/nas/apnc-023205-046-20120910.deb" target="_blank" rel="external">Mybooklive固件地址</a></li>
<li><a href="https://my.oschina.net/u/248080/blog/207665" target="_blank" rel="external">Mybooklive 数据备份和重装系统</a></li>
<li><a href="https://www.mobibrw.com/2014/1297" target="_blank" rel="external">WD My Book Live 离线升级固-件</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://ivaneye.com/2016/11/19/nas.html" data-id="cixcyt6yj0009o3bqpeg4q9cr" class="article-share-link">分享到</a><img src="/img/cli_300px.png"/><div class="tags"><a href="/tags/other/">other</a><a href="/tags/随笔/">随笔</a></div><div class="post-nav"><a href="/2016/11/21/cost.html" class="pre">为时间买单</a><a href="/2016/11/13/vote.html" class="next">李狗嗨与美国大选</a></div><div data-thread-key="2016/11/19/nas.html" data-title="Mybooklive修复" data-url="https://ivaneye.com/2016/11/19/nas.html" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/11/19/nas.html" data-title="Mybooklive修复" data-url="https://ivaneye.com/2016/11/19/nas.html" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://ivaneye.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/architecture/">architecture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/book/">book</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/clojure/">clojure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/consensus/">consensus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/designpattern/">designpattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/how/">how</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/io/">io</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdk/">jdk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit3/">junit3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit4/">junit4</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lighttable/">lighttable</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/luminus/">luminus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/module/">module</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mycode/">mycode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/scala/">scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/think/">think</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/thread/">thread</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/train/">train</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/why/">why</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xmind/">xmind</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/book/" style="font-size: 15px;">book</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/review/" style="font-size: 15px;">review</a> <a href="/tags/read/" style="font-size: 15px;">read</a> <a href="/tags/think/" style="font-size: 15px;">think</a> <a href="/tags/concept/" style="font-size: 15px;">concept</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/designpattern/" style="font-size: 15px;">designpattern</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/clojure/" style="font-size: 15px;">clojure</a> <a href="/tags/osgi/" style="font-size: 15px;">osgi</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/language/" style="font-size: 15px;">language</a> <a href="/tags/graphviz/" style="font-size: 15px;">graphviz</a> <a href="/tags/cdraw/" style="font-size: 15px;">cdraw</a> <a href="/tags/framework/" style="font-size: 15px;">framework</a> <a href="/tags/luminus/" style="font-size: 15px;">luminus</a> <a href="/tags/xmind/" style="font-size: 15px;">xmind</a> <a href="/tags/transactional/" style="font-size: 15px;">transactional</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/scala/" style="font-size: 15px;">scala</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/junit3/" style="font-size: 15px;">junit3</a> <a href="/tags/junit4/" style="font-size: 15px;">junit4</a> <a href="/tags/lighttable/" style="font-size: 15px;">lighttable</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/how/" style="font-size: 15px;">how</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/reactor/" style="font-size: 15px;">reactor</a> <a href="/tags/classloader/" style="font-size: 15px;">classloader</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jigsaw/" style="font-size: 15px;">jigsaw</a> <a href="/tags/module/" style="font-size: 15px;">module</a> <a href="/tags/why/" style="font-size: 15px;">why</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/consensus/" style="font-size: 15px;">consensus</a> <a href="/tags/paxos/" style="font-size: 15px;">paxos</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/iwant.html">散弹枪知识与狙击枪知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/philosophy.html">哲学是个什么鬼?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/27/lunch.html">巴菲特午餐</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/cost.html">为时间买单</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/nas.html">Mybooklive修复</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/13/vote.html">李狗嗨与美国大选</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/06/learn.html">如何高效学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/machine.html">与机器赛跑</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/salary.html">平均薪酬×××，你拖后腿了吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/zhihulive.html">评李笑来的知乎live</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="null" title="null" target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">思考，执行，表达！.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'ivanpig'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>