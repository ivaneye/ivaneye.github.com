<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java模块化:jigsaw初体验 | 思考，执行，表达！</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java模块化:jigsaw初体验</h1><a id="logo" href="/.">思考，执行，表达！</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/" class="current"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java模块化:jigsaw初体验</h1><div class="post-meta">Sep 23, 2015<span> | </span><span class="category"><a href="/categories/module/">module</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2015/09/23/jigsaw-quick-start.html" href="/2015/09/23/jigsaw-quick-start.html#comments" class="ds-thread-count"></a><div class="post-content"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Java模块化一拖再拖，目前jdk9发布了包含jigsaw的先行版。本文为<a href="http://openjdk.java.net/projects/jigsaw/quick-start" target="_blank" rel="external">Project Jigsaw: Module System Quick-Start Guide</a>的简译，及使用感受总结。</p>
<h1 id="翻译正文"><a href="#翻译正文" class="headerlink" title="翻译正文"></a>翻译正文</h1><p>本文提供了一些简单的例子方便开发者熟悉模块化。</p>
<p>例子中的文件路径使用反斜杠和冒号分隔。Windows用户请修改为反斜杠和分号。</p>
<h2 id="Greetings"><a href="#Greetings" class="headerlink" title="Greetings"></a>Greetings</h2><p>第一个例子是个叫com.greetings的模块，它只是简单的打印”Greetings!”。这个模块包含两个源文件:模块定义文件(mmodule-info.java)和主类。</p>
<p>按规定，源文件需要在一个目录下，这个目录表示模块，目录名即模块名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">src/com.greetings/com/greetings/Main.java</div><div class="line">src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> com.greetings &#123; &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/com/greetings/Main.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.greetings;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Greetings!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>使用下面的命令，将源代码编译到mods/com.greetings目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p mods/com.greetings</div><div class="line"></div><div class="line">$ javac -d mods/com.greetings \</div><div class="line">        src/com.greetings/module-info.java \</div><div class="line">        src/com.greetings/com/greetings/Main.java</div></pre></td></tr></table></figure>
<p>通过下面的命令运行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -modulepath mods -m com.greetings/com.greetings.Main</div></pre></td></tr></table></figure>
<ul>
<li>-modulepath 是模块路径，它可以指定一个或多个模块路径。</li>
<li>-m 指定主模块，斜杠后的值为主模块中的主类</li>
</ul>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>就目前这个例子还看不出太多内容，和普通的开发的区别就是新增了module-info.java这个类，来描述模块信息。</p>
<h2 id="Greetings-world"><a href="#Greetings-world" class="headerlink" title="Greetings world"></a>Greetings world</h2><p> 第二个例子升级前面的例子来说明模块间的依赖。模块com.greetings依赖org.astro。模块org.astro导出包org.astro.</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">src/org.astro/module-info.java</div><div class="line">src/org.astro/org/astro/World.java</div><div class="line">src/com.greetings/com/greetings/Main.java</div><div class="line">src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.astro/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">module org.astro &#123;</div><div class="line">    exports org.astro;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.astro/org/astro/World.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.astro;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">World</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"world"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">module com.greetings &#123;</div><div class="line">    requires org.astro;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/com/greetings/Main.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.greetings;</div><div class="line"><span class="keyword">import</span> org.astro.World;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.format(<span class="string">"Greetings %s!%n"</span>, World.name());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分别翻译org.astro模块和com.greetings模块.在编译com.greetings模块时需要指定模块路径，这样才能解析对org.astro的依赖.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mkdir mods/org.astro mods/com.greetings</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ javac -d mods/org.astro \</div><div class="line">        src/org.astro/module-info.java src/org.astro/org/astro/World.java</div><div class="line"></div><div class="line">$ javac -modulepath mods -d mods/com.greetings \</div><div class="line">        src/com.greetings/module-info.java src/com.greetings/com/greetings/Main.java</div></pre></td></tr></table></figure>
<p>运行和前面的例子相同:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -modulepath mods -m com.greetings/com.greetings.Main</div></pre></td></tr></table></figure>
<p>打印出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Greetings world!</div></pre></td></tr></table></figure>
<h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><p>这里主要通过module-info.java来进行导入导出的声明。主要是为了解决模块间依赖关系的处理的。</p>
<p>Java中的访问权限控制符是在类上的，而module-info.java中的导入导出声明是包层面的。</p>
<h2 id="多模块编译"><a href="#多模块编译" class="headerlink" title="多模块编译"></a>多模块编译</h2><p>前面的例子中模块com.greetings和模块org.astro是分开编译的。当然也可以多个模块一起来编译.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ mkdir mods</div><div class="line"></div><div class="line">$ javac -d mods -modulesourcepath src $(find src -name &quot;*.java&quot;)</div><div class="line"></div><div class="line">$ find mods -type f</div><div class="line"></div><div class="line">    mods/com.greetings/com/greetings/Main.class</div><div class="line">    mods/com.greetings/module-info.class</div><div class="line">    mods/org.astro/module-info.class</div><div class="line">    mods/org.astro/org/astro/World.class</div></pre></td></tr></table></figure>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>前面的例子只是简单的编译，而一般为了便于发布，会将模块打包成模块化的jar包。模块化的jar包就是在包的根目录下有一个module-info.class文件，来定义模块信息。<br>下面的命令在mlib目录下打一个叫org.astro@1.0.jar的模块化jar包和一个叫com.greetings.jar的模块化jar包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ mkdir mlib</div><div class="line"></div><div class="line">$ jar --create --archive=mlib/org.astro@1.0.jar \</div><div class="line">        --module-version=1.0 -C mods/org.astro .</div><div class="line"></div><div class="line">$ jar --create --archive=mlib/com.greetings.jar \</div><div class="line">        --main-class=com.greetings.Main -C mods/com.greetings .</div><div class="line"></div><div class="line">$ ls mlib</div><div class="line"></div><div class="line">    com.greetings.jar   org.astro@1.0.jar</div></pre></td></tr></table></figure>
<p>在这个例子中，模块org.astro打包时指定版本为1.0。模块com.greetings打包时指定主类为com.greetings.Main,这样我们可以直接执行模块com.greetings而不需要指明主类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ java -mp mlib -m com.greetings</div><div class="line"></div><div class="line">    Greetings world!</div></pre></td></tr></table></figure>
<p>-modulepath可以简写为-mp。jar命令行工具新增了许多新属性，其中一个是打印模块化jar的模块定义:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ jar --print-module-descriptor --archive=mlib/org.astro@1.0.jar</div><div class="line"></div><div class="line">    Name:</div><div class="line">      org.astro@1.0</div><div class="line">    Requires:</div><div class="line">      java.base [ MANDATED ]</div><div class="line">    Exports:</div><div class="line">      org.astro</div></pre></td></tr></table></figure>
<h2 id="缺少导入或导出"><a href="#缺少导入或导出" class="headerlink" title="缺少导入或导出"></a>缺少导入或导出</h2><p>现在让我们看一下在前面的例子里，如果我们没有对模块进行导入导出声明，会有什么错误!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> com.greetings &#123;</div><div class="line">    <span class="comment">// requires org.astro;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ javac -modulepath mods -d mods/com.greetings \</div><div class="line">        src/com.greetings/module-info.java src/com.greetings/com/greetings/Main.java</div><div class="line"></div><div class="line">    src/com.greetings/com/greetings/Main.java:2: error: package org.astro does not exist</div><div class="line">    import org.astro.World;</div><div class="line">                    ^</div><div class="line">    src/com.greetings/com/greetings/Main.java:5: error: cannot find symbol</div><div class="line">            System.out.format(&quot;Greetings %s!%n&quot;, World.name());</div><div class="line">                                                 ^</div><div class="line">      symbol:   variable World</div><div class="line">      location: class Main</div><div class="line">    2 errors</div></pre></td></tr></table></figure>
<p>现在恢复导入，注释掉导出!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> com.greetings &#123;</div><div class="line">    <span class="keyword">requires</span> org.astro;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.astro/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> org.astro &#123;</div><div class="line">    <span class="comment">// exports org.astro;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ javac -modulepath mods -d mods/com.greetings \</div><div class="line">       src/com.greetings/module-info.java src/com.greetings/com/greetings/Main.java</div><div class="line"></div><div class="line">    src/com.greetings/com/greetings/Main.java:2: error: package org.astro does not exist</div><div class="line">    import org.astro.World;</div><div class="line">                    ^</div><div class="line">    src/com.greetings/com/greetings/Main.java:5: error: cannot find symbol</div><div class="line">            System.out.format(&quot;Greetings %s!%n&quot;, World.name());</div><div class="line">                                                 ^</div><div class="line">      symbol:   variable World</div><div class="line">      location: class Main</div><div class="line">    2 errors\</div></pre></td></tr></table></figure>
<h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><p>服务可以接口服务的消费模块和服务生产模块。</p>
<p>在这个例子中，有一个服务消费模块和一个服务生产模块</p>
<ul>
<li>模块com.socket导出一个网络socket的API。这个API在包com.socket中，所以这个包需要导出。这个API可选择具体的实现。<br>服务类型是同模块下的com.socket.spi.NetworkSocketProvider，所以com.socket.spi这个包也要导出</li>
<li>模块org.fastsocket是服务生产模块。它提供了一个com.socket.spi.NetworkSocketProvider的实现，它不需要导出任何包</li>
</ul>
<p>下面是模块com.socket的源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.socket/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> com.socket &#123;</div><div class="line">    <span class="keyword">exports</span> com.socket;</div><div class="line">    <span class="keyword">exports</span> com.socket.spi;</div><div class="line">    uses com.socket.spi.NetworkSocketProvider;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.socket/com/socket/NetworkSocket.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.socket;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.Closeable;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.ServiceLoader;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.socket.spi.NetworkSocketProvider;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkSocket</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">NetworkSocket</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NetworkSocket <span class="title">open</span><span class="params">()</span> </span>&#123;</div><div class="line">        ServiceLoader&lt;NetworkSocketProvider&gt; sl</div><div class="line">            = ServiceLoader.load(NetworkSocketProvider.class);</div><div class="line">        Iterator&lt;NetworkSocketProvider&gt; iter = sl.iterator();</div><div class="line">        <span class="keyword">if</span> (!iter.hasNext())</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No service providers found!"</span>);</div><div class="line">        NetworkSocketProvider provider = iter.next();</div><div class="line">        <span class="keyword">return</span> provider.openNetworkSocket();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.socket/com/socket/spi/NetworkSocketProvider.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.socket.spi;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.socket.NetworkSocket;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkSocketProvider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">NetworkSocketProvider</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> NetworkSocket <span class="title">openNetworkSocket</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是模块org.fastsocket的源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.fastsocket/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> org.fastsocket &#123;</div><div class="line">    <span class="keyword">requires</span> com.socket;</div><div class="line">    provides com.socket.spi.NetworkSocketProvider</div><div class="line">        with org.fastsocket.FastNetworkSocketProvider;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.fastsocket/org/fastsocket/FastNetworkSocketProvider.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fastsocket;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.socket.NetworkSocket;</div><div class="line"><span class="keyword">import</span> com.socket.spi.NetworkSocketProvider;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastNetworkSocketProvider</span> <span class="keyword">extends</span> <span class="title">NetworkSocketProvider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastNetworkSocketProvider</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> NetworkSocket <span class="title">openNetworkSocket</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FastNetworkSocket();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/org.fastsocket/org/fastsocket/FastNetworkSocket.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.fastsocket;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.socket.NetworkSocket;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastNetworkSocket</span> <span class="keyword">extends</span> <span class="title">NetworkSocket</span> </span>&#123;</div><div class="line">    FastNetworkSocket() &#123; &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir mods</div><div class="line">$ javac -d mods -modulesourcepath src $(find src -name &quot;*.java&quot;)</div></pre></td></tr></table></figure>
<p>最后修改模块com.greetings来使用这个API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/module-info.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> com.greetings &#123;</div><div class="line">    <span class="keyword">requires</span> com.socket;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat src/com.greetings/com/greetings/Main.java</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.greetings;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.socket.NetworkSocket;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        NetworkSocket s = NetworkSocket.open();</div><div class="line">        System.out.println(s.getClass());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ javac -d mods/com.greetings/ -mp mods $(find src/com.greetings/ -name &quot;*.java&quot;)</div></pre></td></tr></table></figure>
<p>最后我们来运行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ java -mp mods -m com.greetings/com.greetings.Main</div><div class="line"></div><div class="line">class org.fastsocket.FastNetworkSocket</div></pre></td></tr></table></figure>
<p>从输出可以看到服务的生产者已经被确定，并被当作NetworkSocket的工厂类来使用.</p>
<h3 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h3><p>上面说API可以动态选择具体的实现，如何选择并没有说明！</p>
<h2 id="链接-The-linker"><a href="#链接-The-linker" class="headerlink" title="链接(The linker)"></a>链接(The linker)</h2><p>jlink是链接工具可以根据模块间的传递依赖来链接模块，构建出一个自定义的模块化运行时镜像(image)</p>
<p>目前这个工具需要被链接的模块是以模块化的jar或JMOD格式提供的。</p>
<p>下面的例子船舰一个运行时镜像，它包含了com.greetings模块和它的依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jlink --modulepath $JAVA_HOME/jmods:mlib --addmods com.greetings --output greetingsapp</div></pre></td></tr></table></figure>
<p>$JAVA_HOME/jmods目录包含了java.base.jmod和其他标准JDK模块。如果你使用你自己构建的OpenJDK，<br>那么jmod文件在$BUILDOUTPUT/images/jmods目录下，$BUILDOUTPUT是构建输出目录。</p>
<p>mlib目录包含了模块com.greetings需要的内容.</p>
<p>jlink工具支持很多高级属性，请通过jlink –help查看</p>
<p>在这里，jlink工具通过默认规则链接服务，所以镜像里会包含你其实并不需要的内容.</p>
<h2 id="javac-Xmodule-and-java-Xoverride"><a href="#javac-Xmodule-and-java-Xoverride" class="headerlink" title="javac -Xmodule and java -Xoverride"></a>javac -Xmodule and java -Xoverride</h2><p>以前开发者修改类时，首先从CVS检出j，比如ava.util.concurrent类，编译源码，然后通过-Xbootclasspath/p来部署。</p>
<p>-Xbootclasspath/p 已经废弃了，现在可使用-Xoverride来实现同样的功能。-Xoverride可以用一个模块中的类覆盖另一个模块中的类。<br>后面，javac在编译一个包里的类时，如果已经存在在某个模块中，则会有警告。如果要为某个以存在的模块编译类，需要添加-Xmodule属性.</p>
<p>下面是个例子，它编译一个新版本的java.util.concurrent.ConcurrentHashMap，并使用它:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">javac -Xmodule:java.base -d mypatches/java.base \</div><div class="line">        src/java.base/java/util/concurrent/ConcurrentHashMap.java</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -Xoverride:mypatches ...</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>总体来说，初次体验jigsaw感觉要优于OSGi</li>
<li>jigsaw不需要第三方运行环境，对于开发者来说要比OSGi更友好</li>
<li>jigsaw自带解决传递依赖的工具</li>
<li>jigsaw在编译期就能处理模块间的依赖，而不像OSGi需要到运行时才报模块依赖问题。主要还是第二点:jigsaw不需要第三方运行环境</li>
<li>jigsaw可以动态选择实现，但是如何实现例子中没有提到!(网上查资料说:jigsaw并不支持OSGi那样的dynamic Service，就是说不支持动态的装载和卸载Service了。需要进一步证实)</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://ivaneye.com/2015/09/23/jigsaw-quick-start.html" data-id="cixcyt7ky00jeo3bq0flsc935" class="article-share-link">分享到</a><img src="/img/cli_300px.png"/><div class="tags"><a href="/tags/java/">java</a><a href="/tags/jigsaw/">jigsaw</a><a href="/tags/module/">module</a></div><div class="post-nav"><a href="/2015/10/29/docker-first.html" class="pre">Docker初探</a><a href="/2015/06/07/cdraw.html" class="next">Clojure绘制UML</a></div><div data-thread-key="2015/09/23/jigsaw-quick-start.html" data-title="Java模块化:jigsaw初体验" data-url="https://ivaneye.com/2015/09/23/jigsaw-quick-start.html" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/09/23/jigsaw-quick-start.html" data-title="Java模块化:jigsaw初体验" data-url="https://ivaneye.com/2015/09/23/jigsaw-quick-start.html" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://ivaneye.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/architecture/">architecture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/book/">book</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/clojure/">clojure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/code/">code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/consensus/">consensus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/designpattern/">designpattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/how/">how</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/io/">io</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jdk/">jdk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit3/">junit3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/junit4/">junit4</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lighttable/">lighttable</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/luminus/">luminus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/module/">module</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mycode/">mycode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/scala/">scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/think/">think</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/thread/">thread</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/train/">train</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/why/">why</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xmind/">xmind</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/book/" style="font-size: 15px;">book</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/review/" style="font-size: 15px;">review</a> <a href="/tags/read/" style="font-size: 15px;">read</a> <a href="/tags/think/" style="font-size: 15px;">think</a> <a href="/tags/concept/" style="font-size: 15px;">concept</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/designpattern/" style="font-size: 15px;">designpattern</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/clojure/" style="font-size: 15px;">clojure</a> <a href="/tags/osgi/" style="font-size: 15px;">osgi</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/language/" style="font-size: 15px;">language</a> <a href="/tags/graphviz/" style="font-size: 15px;">graphviz</a> <a href="/tags/cdraw/" style="font-size: 15px;">cdraw</a> <a href="/tags/framework/" style="font-size: 15px;">framework</a> <a href="/tags/luminus/" style="font-size: 15px;">luminus</a> <a href="/tags/xmind/" style="font-size: 15px;">xmind</a> <a href="/tags/transactional/" style="font-size: 15px;">transactional</a> <a href="/tags/index/" style="font-size: 15px;">index</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/scala/" style="font-size: 15px;">scala</a> <a href="/tags/opensource/" style="font-size: 15px;">opensource</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/junit3/" style="font-size: 15px;">junit3</a> <a href="/tags/junit4/" style="font-size: 15px;">junit4</a> <a href="/tags/lighttable/" style="font-size: 15px;">lighttable</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/how/" style="font-size: 15px;">how</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/reactor/" style="font-size: 15px;">reactor</a> <a href="/tags/classloader/" style="font-size: 15px;">classloader</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jigsaw/" style="font-size: 15px;">jigsaw</a> <a href="/tags/module/" style="font-size: 15px;">module</a> <a href="/tags/why/" style="font-size: 15px;">why</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/consensus/" style="font-size: 15px;">consensus</a> <a href="/tags/paxos/" style="font-size: 15px;">paxos</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/iwant.html">散弹枪知识与狙击枪知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/philosophy.html">哲学是个什么鬼?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/27/lunch.html">巴菲特午餐</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/cost.html">为时间买单</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/19/nas.html">Mybooklive修复</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/13/vote.html">李狗嗨与美国大选</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/06/learn.html">如何高效学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/machine.html">与机器赛跑</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/salary.html">平均薪酬×××，你拖后腿了吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/zhihulive.html">评李笑来的知乎live</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="null" title="null" target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">思考，执行，表达！.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'ivanpig'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>